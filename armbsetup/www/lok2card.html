<!DOCTYPE html>
<html lang="en">
<!-- locolist to lococard converter by Marcel Maage, updated 2024 - 2026 by Rainer Müller -->
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 to lococard Converter</title>
    <style>
        table, th, td {
          border: 1px solid black;
          height: 24px;
        }

        body{margin: 0px;}
        body,p,div,h1,h2,td,th{font-family:sans-serif;font-size:12px}
        header{font-size:20px;color:white; background-color:#96B11C;margin:1px;padding:5px;}
        h1{font-size:20px;color:white; background-color:#96B11C;margin:1px;padding:5px;}
        h2, button, input {font-size:18px;}
        p,h2{margin:0px0px5px0px}

        body {
        font-family: "Lato", sans-serif;
        transition: background-color .5s;
        }

		#name {
		border: none;
		width: 160px
		}
    </style>
</head>
<body>
    <h1>CS2 to lococard Converter</h1>
    <br><div><font size=4><b>Format Card-Image:
    <select id="cardformat" onChange="modified()">
        <option value="0"> Minimal
        <option selected value="1"> Standard
        <option value="2"> Standard + Icon
    </select>
    &nbsp;&nbsp;
    <input type="checkbox" id="cardfill" onChange="modified()"> Auffüllen
    </b></font></div>
    <br><hr><br>
    <button type="button" id="fromserver">Server</button>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <input type="file" name="cs2InputFile" id="cs2InputFile">
    <br>
    <br>
    <div class="locoTableContainer">
        <table>
            <thead>
                <th>Name</th>
                <th>Icon</th>
                <th>Adresse</th>
                <th>Format</th>
                <th>File-Download</th>
                <th>Bytes</th>
                <th>Lokkarte</th>
            </thead>
            <tbody id="locoTable">
            </tbody>
        </table>
    </div>

    <pre id="debugOutput"></pre>

    <script src="lib/jspdf.umd.min.js"></script>
    <script type="text/javascript">

        var lokomotiveCs2 = 0;
		var cardFormat = 0;
        'use strict';

        document.getElementById('fromserver')
        .addEventListener('click', function() {
            fetch('config/lokomotive.cs2', { cache: "no-store" })
              .then(response => response.blob())
              .then(blob => {
                 var fr=new FileReader();
                 fr.onload=function(){
                    locoTable.innerHTML = "";
                    createLocoTable(fr.result);
                 }
            fr.readAsText(blob);
            });
        })

        document.getElementById('cs2InputFile')
            .addEventListener('change', function() {

            var fr=new FileReader();
            fr.onload=function(){
                locoTable.innerHTML = "";
                createLocoTable(fr.result);
            }
            fr.readAsText(this.files[0]);
        })

        function modified()
        {
            locoTable.innerHTML = "";
        }

        function createLocoTable(lokomotiveCs2)
        {
            lokomotiveCs2 = lokomotiveCs2.replace(/(\r\n)/gm,"\n");
            if (lokomotiveCs2.substring(0, 12) === "[lokomotive]") {
            let locoArray = lokomotiveCs2.split(' .name=');
            //let index = locoArray[1].search(/\n/);
            //document.getElementById('debugOutput').textContent=locoArray[1].substr(0, index);

            //remove first element of Array
            locoArray.shift();
            locoArray.forEach((loco)=>{
                analyzeLoco(loco);
            });
            }
            else alert("Falsche Dateikennung");
        }

        function analyzeLoco(data)
        {
            // get buffer for data
            let binData = new Uint8Array(8192);

            // extract name of loco
            const name = data.substring(0, data.indexOf('\n'));

            // get adress
            const adress = getNumber(data, '.adresse=');

            // get protocol
            const protocol = getString(data, '.typ=');

            cardFormat = document.getElementById('cardformat').value;
            let binIndex = 0;
            // in order to detect the correct protocol, i have to get number of functions first
            /*switch (protocol) {
                case "mm":
                    binData[binIndex++] = 2;
                    binData[binIndex++] = 117;
                    binData[binIndex++] = 0;
                break;

                case "mm2_prg":
                    binData[binIndex++] = 2;
                    binData[binIndex++] = 231;
                    binData[binIndex++] = 0;
                break;

                case "mfx":
                    binData[binIndex++] = 2;
                    binData[binIndex++] = 229;
                    binData[binIndex++] = 0;
                break;

                case "dcc":
                    binData[binIndex++] = 2;
                    binData[binIndex++] = 197;
                    binData[binIndex++] = 0;
                break;

                default:
                    binData[binIndex++] = 2;
                    binData[binIndex++] = 231;
                    binData[binIndex++] = 0;
            } */
            binData[binIndex++] = 2;
            binData[binIndex++] = 117;
            binData[binIndex++] = 0;

            // get uid
            const uid = getNumber(data, '.uid=');

            // add uid to bin
            binData[binIndex++] = 1;
            binData[binIndex++] = 4;
            binData[binIndex++] = uid;
            binData[binIndex++] = uid/256;
            binData[binIndex++] = uid/65536;
            binData[binIndex++] = uid/16777216;

            // add adress to bin
            binData[binIndex++] = 2;
            binData[binIndex++] = 2;
            binData[binIndex++] = adress;
            binData[binIndex++] = adress/256;

            // get acceleration delay
            const av = getNumber(data, '.av=');
            // add av to bin
            binData[binIndex++] = 3;
            binData[binIndex++] = 1;
            binData[binIndex++] = av;

            // get slow down delay
            const bv = getNumber(data, '.bv=');
            // add bv to bin
            binData[binIndex++] = 4;
            binData[binIndex++] = 1;
            binData[binIndex++] = bv;

            // get vmin
            const vmin = getNumber(data, '.vmin=');
            // add vmin to bin
            binData[binIndex++] = 5;
            binData[binIndex++] = 1;
            binData[binIndex++] = vmin;

            // get vmax
            const vmax = getNumber(data, '.vmax=');
            // add vmax to bin
            binData[binIndex++] = 6;
            binData[binIndex++] = 1;
            binData[binIndex++] = vmax;

            // add tacho to bin
            const tacho = getNumber(data, '.tachomax=');
            if(!Number.isNaN(tacho))
            {
                binData[binIndex++] = 7;
                binData[binIndex++] = 2;
                binData[binIndex++] = tacho;
                binData[binIndex++] = tacho/256;
            }

            // get volume
            const volume = getNumber(data, '.volume=');
            // add volume to bin
            binData[binIndex++] = 8;
            binData[binIndex++] = 1;
            binData[binIndex++] = volume;

            // add functions to bin
            let functions = data.substring(data.indexOf('.funktionen\n')+13).split('.funktionen\n');
            var fublsz;
            if (cardFormat > 0)
                fublsz = 160;
            else
                fublsz = functions.length * 10;
            if (fublsz > 80)
                binData[1] = 197;
            binData[binIndex++] = 9;
            binData[binIndex++] = fublsz;
            let fubase = binIndex;
            functions.forEach((locoFunction)=>{
                binData[binIndex++] = getNumber(locoFunction, '..typ=');
                const dauer = getNumber(locoFunction, '..dauer=');
                if(!Number.isNaN(dauer))
                {
                    binData[binIndex++] = dauer;
                }
                else
                {
                    binIndex++;
                }
                binIndex+=8;
            });
            binIndex = fubase + fublsz;

            // add functions_2 to bin
            binData[binIndex++] = 13;
            binData[binIndex++] = 32;
            let numberOfFunctions = 32;
            let fu2offs = data.indexOf('.funktionen_2\n');
            if (fu2offs >= 0) {
              binData[1] = 229;
              let functions2 = data.substring(fu2offs+15).split('.funktionen_2\n');
              functions2.forEach((locoFunction)=>{
                const typ2 = getNumber(locoFunction, '..typ=');
                if(!Number.isNaN(typ2))
                {
                    binData[binIndex++] = typ2;
                }
                else
                {
                    binData[binIndex++] = 0;
                }
                const dauer2 = getNumber(locoFunction, '..dauer=');
                if(!Number.isNaN(dauer2))
                {
                    binData[binIndex++] = dauer2;
                }
                else
                {
                    binData[binIndex++] = 0;
                }
                numberOfFunctions-=2;
              });
              binIndex += numberOfFunctions;
            }
            else if (cardFormat > 0) {
              binData[1] = 229;
              binIndex += 32;		// insert dummy block
            }
            else binIndex -= 2;		// turn back

            // get mfx uid
            const mfxuid = getNumber(data, '.mfxuid=');
            // add mfx uid to bin
            binData[binIndex++] = 10;
            binData[binIndex++] = 4;
            binData[binIndex++] = mfxuid;
            binData[binIndex++] = mfxuid/256;
            binData[binIndex++] = mfxuid/65536;
            binData[binIndex++] = mfxuid/16777216;

            const symbol = getNumber(data, '.symbol=');
            // add symbol to bin as CS2
            binData[binIndex++] = 14;
            binData[binIndex++] = 1;
            binData[binIndex++] = symbol;

            // add symbol to bin as MS2
            binData[binIndex++] = 15;
            binData[binIndex++] = 1;
            binData[binIndex++] = symbol;

            let indexMxf = data.indexOf('.mfxAdr');
            if(indexMxf >= 0)
            {
                // add mfx block to bin
                binData[binIndex++] = 12;
                binData[binIndex++] = 16;
                indexMxf += '.mfxAdr'.length;
                const mfxStruct = data.substring(indexMxf);
                const target = getNumber(mfxStruct, '..target=');
                binData[binIndex++] = target;
                binData[binIndex++] = target/256;
                const nameIndex = data.indexOf('..name=');
                if(nameIndex >= 0)
                {
                    const mfxName = getNumber(mfxStruct, '..name=');
                    binData[binIndex++] = mfxName;
                    binData[binIndex++] = mfxName/256;
                }
                else
                {
                    const mfxName = getNumber(mfxStruct, '..name');
                    binData[binIndex++] = mfxName;
                    binData[binIndex++] = mfxName/256;
                }
                const speedtable = getNumber(mfxStruct, '..speedtable=');
                binData[binIndex++] = speedtable;
                binData[binIndex++] = speedtable/256;
                const addr = getNumber(mfxStruct, '..addr=');
                binData[binIndex++] = addr;
                binData[binIndex++] = addr/256;
                const xcel = getNumber(mfxStruct, '..xcel=');
                binData[binIndex++] = xcel;
                binData[binIndex++] = xcel/256;
                const volume = getNumber(mfxStruct, '..volume=');
                binData[binIndex++] = volume;
                binData[binIndex++] = volume/256;
                const numfunc = getNumber(mfxStruct, '..numfunc=');
                binData[binIndex++] = numfunc;
                binData[binIndex++] = numfunc/256;
                const func = getNumber(mfxStruct, '..func=');
                binData[binIndex++] = func;
                binData[binIndex++] = func/256;
                if (cardFormat > 0) {
                  binData[1] = 23;
                  binData[2] = 1;
                }
            }

            // add name and protocol string to bin
            binData[binIndex++] = 0;
            binData[binIndex++] = 3;
            var hook = binIndex;
            binData[binIndex++] = name.length + protocol.length + 5;
            binData[binIndex++] = (name.length + protocol.length + 5) / 256;
            binData[binIndex++] = 30;
            binData[binIndex++] = name.length;
            for (let i = 0; i < name.length; i++) {
                binData[binIndex++] = name.charCodeAt(i);
            }
            binData[binIndex++] = 31;
            binData[binIndex++] = protocol.length;
            for (let i = 0; i < protocol.length; i++) {
                binData[binIndex++] = protocol.charCodeAt(i);
            }

            // get icon
            const icon = getString(data, '.icon=');
            const locoIcon = document.createElement("img");
            locoIcon.alt = icon;

            // add loco icon to bin
            fetch(`icons/${icon}.png`)
              .then((response) => {
               if (response.ok) {
                 response.arrayBuffer().then((abuf) => {
                   const objectURL = URL.createObjectURL(new Blob([abuf]));
                   locoIcon.src = objectURL;

                   // add loco icon name and icon data to bin
                   if (cardFormat == 2) {
                     binData[binIndex++] = 32;
                     binData[binIndex++] = icon.length;
                     binData[hook] += icon.length + 2;	// correction of group length
                     for (let i = 0; i < icon.length; i++) {
                       binData[binIndex++] = icon.charCodeAt(i);
                     }
                     let buf = new Uint8Array(abuf);
                     if ((binIndex + buf.byteLength + 6) <= binData.length) {
                       binData[binIndex++] = 0;
                       binData[binIndex++] = 5;
                       binData[binIndex++] = buf.byteLength;
                       binData[binIndex++] = buf.byteLength / 256;
                       binData.set(buf, binIndex);
                       binIndex += buf.byteLength;
                     }
                     else alert(`Dateiabbild für ${name} zu groß für Karte.`);
                   }
                   addLocoToTable(name, locoIcon, adress, protocol, binData, binIndex, fubase);
                 });
               }
               else addLocoToTable(name, locoIcon, adress, protocol, binData, binIndex, fubase);
            })
               .catch((err) => {
                   addLocoToTable(err.message, locoIcon, adress, protocol, binData, binIndex, fubase);
            });
        }

        function getNumber(data, string)
        {
            let index = data.indexOf(string)
            if(index >= 0)
            {
                index += string.length;
                return Number(data.substring(index, data.indexOf('\n', index)));
            }
            else
            {
                return NaN;
            }
        }

        function getString(data, string)
        {
            let index = data.indexOf(string);
            if(index>=0)
            {
                index += string.length;
                return data.substring(index, data.indexOf('\n', index));
            }
            else
            {
                return "";
            }
        }

        function addLocoToTable(name, locoIcon, adr, protocol, binFile, binIndex, fubase)
        {
            const locoLine = document.createElement("tr");
            const locoName = document.createElement("th");

            const locobut = document.createElement("input");
            locobut.value = name;
            locobut.type = "submit";
			locobut.id = "name";
            locobut.addEventListener('click', function() {
				LocoPrint(name, locoIcon, adr, protocol, binFile, fubase);
            });
            locoName.appendChild(locobut);

            locoLine.appendChild(locoName);

            locoIcon.height = 24;
            locoLine.appendChild(locoIcon);

            const locoAdr = document.createElement("th");
            locoAdr.innerText = adr;
            locoLine.appendChild(locoAdr);

            const locoProtocol = document.createElement("th");
            locoProtocol.innerText = protocol + ' => ' + (binFile[1] + 256 * binFile[2]);
            locoLine.appendChild(locoProtocol);

            const locoFile = document.createElement("th");
            const locoRef = document.createElement("a");
            if (! document.getElementById('cardfill').checked)
               binFile = binFile.subarray(0, binIndex+2);
            var file = new Blob([binFile], {'text/bin': 'text/bin'});
            locoRef.href = URL.createObjectURL(file);
            const fileName = name.replace(/ /g, '_');
            locoRef.download = `${fileName}.bin`;
            locoRef.innerText = `${fileName}.bin`;
            locoFile.appendChild(locoRef);
            locoLine.appendChild(locoFile);

            const fileSize = document.createElement("th");
            fileSize.innerText = binFile.length;
            if ((cardFormat == 2) && (binIndex < 384))
                fileSize.style.color = "red";
            locoLine.appendChild(fileSize);

            const wrcard = document.createElement("input");
            wrcard.value = "Speichern";
            wrcard.type = "submit";
            wrcard.addEventListener('click', function() {
                const formData = new FormData();
                formData.append("cardimg", file);
                fetch ('write2card.php', {
                    method: "POST",
                    body: formData
                })
                .then ((response) => response.text())
                .then ((text) => {
                    alert(`Transfer ${fileName} auf Karte: ${text}`);
                });
            });
            locoLine.appendChild(wrcard);

            locoTable.appendChild(locoLine);
        }

    function LocoPrint(name, locoIcon, adr, protocol, binFile, fubase)
	{
	const { jsPDF } = window.jspdf;

	const doc = new jsPDF({
	  orientation: "landscape",
	  unit: "mm",
	  format: [86, 54]
	});

	try {
	doc.addImage(locoIcon, 'PNG', 15, 6, 65, 20);
	} catch (e) {
	console.log("File missing for icon " + locoIcon.alt);
	}
	doc.setFontSize(18);
	doc.text(name, 15, 35);
	switch (protocol.charAt(1)) {
	case 'c':
		var aline = "DCC Adr. " + adr;
		break;
	case 'f':
		var aline = "mfx";
		break;
	case 'm':
		var aline = "MM Adr. " + adr;
		break;
	}
	doc.setFontSize(10);
	doc.text(aline, 80, 50, align="right");
	for (let f = 0; f < 60; f += 10) {
		var ficon = binFile[fubase + f];
		if (ficon > 0 && f < binFile[fubase - 1]) {
			if (ficon > 127)
				ficon -= 128;
			var fname = ficon.toString();
			if (ficon < 10)
				fname = "0" + fname;
			try {
			doc.addImage("fcticons/FktIcon_a_sw_" + fname + ".png", 'PNG', 15 + f, 38, 9, 9);
			} catch (e) {
			console.log("File missing for func " + fname);
			}
		}
	}
	doc.triangle(2, 27, 10, 10, 10, 44);
	const fileName = name.replace(/ /g, '_');
	doc.save(fileName + ".pdf");
    }
    </script>
</body>
</html>
